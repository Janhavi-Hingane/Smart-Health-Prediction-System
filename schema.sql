
-- Create database (run in MySQL)
CREATE DATABASE IF NOT EXISTS healthdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE healthdb;

CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(200) UNIQUE NOT NULL,
  password_hash VARCHAR(200) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'USER'
);

CREATE TABLE IF NOT EXISTS symptoms (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS diseases (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(150) UNIQUE NOT NULL,
  precaution VARCHAR(255),
  medicine VARCHAR(255)
);

CREATE TABLE IF NOT EXISTS disease_symptom (
  disease_id INT NOT NULL,
  symptom_id INT NOT NULL,
  PRIMARY KEY (disease_id, symptom_id),
  CONSTRAINT fk_ds_d FOREIGN KEY (disease_id) REFERENCES diseases(id) ON DELETE CASCADE,
  CONSTRAINT fk_ds_s FOREIGN KEY (symptom_id) REFERENCES symptoms(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS history (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  input_text TEXT NOT NULL,
  predicted_disease_id INT NULL,
  created_at DATETIME NOT NULL,
  CONSTRAINT fk_h_u FOREIGN KEY (user_id) REFERENCES users(id),
  CONSTRAINT fk_h_d FOREIGN KEY (predicted_disease_id) REFERENCES diseases(id)
);

-- Seed basic symptoms
INSERT IGNORE INTO symptoms(name) VALUES
('Fever'),('Cough'),('Headache'),('Sore Throat'),('Runny Nose'),
('Fatigue'),('Nausea'),('Vomiting'),('Diarrhea'),('Abdominal Pain'),
('Shortness of Breath'),('Chest Pain'),('Rash'),('Joint Pain'),('Body Ache');

-- Seed diseases
INSERT IGNORE INTO diseases(name, precaution, medicine) VALUES
('Common Cold','Rest, fluids, steam inhalation','Antihistamines'),
('Influenza','Rest, hydration, isolate','Oseltamivir (if prescribed)'),
('Food Poisoning','Hydration, ORS, avoid solid food','ORS, antiemetics'),
('Migraine','Dark quiet room, hydration','Triptans, NSAIDs');

-- Map disease to symptoms
INSERT IGNORE INTO disease_symptom(disease_id, symptom_id)
SELECT d.id, s.id FROM diseases d JOIN symptoms s
ON ( (d.name='Common Cold'    AND s.name IN ('Runny Nose','Cough','Sore Throat'))
  OR (d.name='Influenza'      AND s.name IN ('Fever','Cough','Fatigue','Body Ache'))
  OR (d.name='Food Poisoning' AND s.name IN ('Nausea','Vomiting','Diarrhea','Abdominal Pain'))
  OR (d.name='Migraine'       AND s.name IN ('Headache','Nausea')) );

-- Demo admin user (password: admin123)
-- Hash will be generated by app during registration; create via UI, or insert manually with bcrypt elsewhere if needed.
